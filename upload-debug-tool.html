<!DOCTYPE html>
<html>
<head>
    <title>🔧 Backend Upload Test & Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { border: 1px solid #ccc; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #b8daff; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input[type="file"] { margin: 10px 0; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Backend Upload Test & Debug Tool</h1>
        <p><strong>Purpose:</strong> Test upload endpoints and debug issues</p>
        
        <div class="test-section">
            <h2>🔍 System Status Check</h2>
            <button onclick="checkSystemStatus()">Check Backend Status</button>
            <div id="systemResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>📤 Upload Test</h2>
            <input type="file" id="fileInput" accept="image/*" multiple>
            <br>
            <button onclick="testSingleUpload()">Test Single Upload</button>
            <button onclick="testMultipleUpload()">Test Multiple Upload</button>
            <div id="uploadResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>🗑️ Delete Test</h2>
            <input type="text" id="deleteUrl" placeholder="Enter image URL to delete">
            <br>
            <button onclick="testDelete()">Test Delete</button>
            <div id="deleteResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>📊 Debug Log</h2>
            <button onclick="clearLog()">Clear Log</button>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = '';
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        async function checkSystemStatus() {
            log('Checking system status...');
            
            try {
                // Test basic connectivity
                const response = await fetch('http://localhost:8080/api/events');
                if (response.ok) {
                    log('✅ Backend API responding');
                } else {
                    log(`⚠️ Backend API status: ${response.status}`);
                }

                // Test upload endpoints
                const uploadResponse = await fetch('http://localhost:8080/api/upload/event-image', {
                    method: 'OPTIONS'
                });
                
                if (uploadResponse.status === 200 || uploadResponse.status === 405) {
                    log('✅ Upload endpoint exists');
                    showResult('systemResult', '✅ Backend is running and upload endpoints are available', 'success');
                } else if (uploadResponse.status === 404) {
                    log('❌ Upload endpoint missing');
                    showResult('systemResult', '❌ Upload endpoints not found (404)', 'error');
                } else {
                    log(`⚠️ Upload endpoint status: ${uploadResponse.status}`);
                    showResult('systemResult', `⚠️ Upload endpoint status: ${uploadResponse.status}`, 'info');
                }

            } catch (error) {
                log(`❌ System check failed: ${error.message}`);
                showResult('systemResult', `❌ Backend not responding: ${error.message}`, 'error');
            }
        }

        async function testSingleUpload() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                showResult('uploadResult', '❌ Please select a file first', 'error');
                return;
            }

            const file = files[0];
            log(`Testing single upload with file: ${file.name} (${file.size} bytes, ${file.type})`);

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('http://localhost:8080/api/upload/event-image', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    log(`✅ Single upload successful: ${result.url}`);
                    showResult('uploadResult', `✅ Upload successful!\nURL: ${result.url}`, 'success');
                    
                    // Test if image is accessible
                    testImageAccess(result.url);
                } else {
                    log(`❌ Single upload failed: ${result.error || result.message}`);
                    showResult('uploadResult', `❌ Upload failed: ${result.error || result.message}`, 'error');
                }

            } catch (error) {
                log(`❌ Single upload error: ${error.message}`);
                showResult('uploadResult', `❌ Upload error: ${error.message}`, 'error');
            }
        }

        async function testMultipleUpload() {
            const fileInput = document.getElementById('fileInput');
            const files = Array.from(fileInput.files);
            
            if (files.length === 0) {
                showResult('uploadResult', '❌ Please select files first', 'error');
                return;
            }

            if (files.length > 5) {
                showResult('uploadResult', '❌ Maximum 5 files allowed', 'error');
                return;
            }

            log(`Testing multiple upload with ${files.length} files`);

            const formData = new FormData();
            files.forEach(file => {
                formData.append('images', file);
                log(`Adding file: ${file.name} (${file.size} bytes, ${file.type})`);
            });

            try {
                const response = await fetch('http://localhost:8080/api/upload/event-images', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    log(`✅ Multiple upload successful: ${result.urls.length} files uploaded`);
                    showResult('uploadResult', `✅ Multiple upload successful!\nUploaded ${result.urls.length} files:\n${result.urls.join('\n')}`, 'success');
                    
                    // Test first image access
                    if (result.urls.length > 0) {
                        testImageAccess(result.urls[0]);
                    }
                } else {
                    log(`❌ Multiple upload failed: ${result.error || result.message}`);
                    showResult('uploadResult', `❌ Multiple upload failed: ${result.error || result.message}`, 'error');
                }

            } catch (error) {
                log(`❌ Multiple upload error: ${error.message}`);
                showResult('uploadResult', `❌ Multiple upload error: ${error.message}`, 'error');
            }
        }

        async function testDelete() {
            const deleteUrl = document.getElementById('deleteUrl').value;
            
            if (!deleteUrl) {
                showResult('deleteResult', '❌ Please enter an image URL to delete', 'error');
                return;
            }

            log(`Testing delete for URL: ${deleteUrl}`);

            try {
                const response = await fetch('http://localhost:8080/api/upload/event-image', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ imageUrl: deleteUrl })
                });

                const result = await response.json();
                
                if (response.ok) {
                    log(`✅ Delete successful`);
                    showResult('deleteResult', '✅ Image deleted successfully', 'success');
                } else {
                    log(`❌ Delete failed: ${result.error || result.message}`);
                    showResult('deleteResult', `❌ Delete failed: ${result.error || result.message}`, 'error');
                }

            } catch (error) {
                log(`❌ Delete error: ${error.message}`);
                showResult('deleteResult', `❌ Delete error: ${error.message}`, 'error');
            }
        }

        function testImageAccess(imageUrl) {
            log(`Testing image access: ${imageUrl}`);
            
            const img = new Image();
            img.onload = () => {
                log(`✅ Image accessible: ${imageUrl} (${img.width}x${img.height})`);
            };
            img.onerror = () => {
                log(`❌ Image not accessible: ${imageUrl}`);
            };
            img.src = imageUrl;
        }

        // Auto-check system status on page load
        window.onload = () => {
            log('Page loaded, checking system status...');
            checkSystemStatus();
        };
    </script>
</body>
</html>
